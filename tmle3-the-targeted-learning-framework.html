<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 tmle3 – The Targeted Learning Framework | The tlverse Software Ecosystem for Causal Inference</title>
  <meta name="description" content="An open-source and fully-reproducible electronic set of teaching materials accompanying a full-day short-course on applying the Targeted Learning methodology in practice using the tlverse software ecosystem." />
  <meta name="generator" content="bookdown  and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 tmle3 – The Targeted Learning Framework | The tlverse Software Ecosystem for Causal Inference" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://tlverse.org/acic2019-workshop/" />
  
  <meta property="og:description" content="An open-source and fully-reproducible electronic set of teaching materials accompanying a full-day short-course on applying the Targeted Learning methodology in practice using the tlverse software ecosystem." />
  <meta name="github-repo" content="tlverse/acic2019-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 tmle3 – The Targeted Learning Framework | The tlverse Software Ecosystem for Causal Inference" />
  
  <meta name="twitter:description" content="An open-source and fully-reproducible electronic set of teaching materials accompanying a full-day short-course on applying the Targeted Learning methodology in practice using the tlverse software ecosystem." />
  

<meta name="author" content="Mark van der Laan, Alan Hubbard, Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/logos/favicons/favicon.png" type="image/x-icon" />
<link rel="prev" href="modern-super-machine-learning-with-sl3.html">
<link rel="next" href="optimal-individualized-treatment-regimes.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.6/visNetwork.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The Hitchhiker's Guide to the tlverse</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-this-workshop"><i class="fa fa-check"></i>About this workshop</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#outline"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-instructors"><i class="fa fa-check"></i>About the instructors</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#mark-van-der-laan"><i class="fa fa-check"></i>Mark van der Laan</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#alan-hubbard"><i class="fa fa-check"></i>Alan Hubbard</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#jeremy-coyle"><i class="fa fa-check"></i>Jeremy Coyle</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#nima-hejazi"><i class="fa fa-check"></i>Nima Hejazi</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#ivana-malenica"><i class="fa fa-check"></i>Ivana Malenica</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#rachael-phillips"><i class="fa fa-check"></i>Rachael Phillips</a></li>
</ul></li>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#important-links"><i class="fa fa-check"></i><b>0.1</b> Important links</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#setup-instructions"><i class="fa fa-check"></i><b>0.2</b> Setup instructions</a><ul>
<li class="chapter" data-level="0.2.1" data-path="index.html"><a href="index.html#r-and-rstudio"><i class="fa fa-check"></i><b>0.2.1</b> R and RStudio</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="motivation.html"><a href="motivation.html"><i class="fa fa-check"></i>Motivation</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Welcome to the <code>tlverse</code></a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#learning-objectives"><i class="fa fa-check"></i><b>1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#what-is-the-tlverse"><i class="fa fa-check"></i><b>1.2</b> What is the <code>tlverse</code>?</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#tlverse-components"><i class="fa fa-check"></i><b>1.3</b> <code>tlverse</code> components</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#installation"><i class="fa fa-check"></i><b>1.4</b> Installation</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#the-targeted-learning-roadmap"><i class="fa fa-check"></i><b>1.5</b> The Targeted Learning Roadmap</a><ul>
<li class="chapter" data-level="1.5.1" data-path="intro.html"><a href="intro.html#the-statistical-model"><i class="fa fa-check"></i><b>1.5.1</b> The Statistical Model</a></li>
<li class="chapter" data-level="1.5.2" data-path="intro.html"><a href="intro.html#the-causal-model"><i class="fa fa-check"></i><b>1.5.2</b> The Causal Model</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#the-parameter-of-interest"><i class="fa fa-check"></i><b>1.6</b> The Parameter of Interest</a><ul>
<li class="chapter" data-level="1.6.1" data-path="intro.html"><a href="intro.html#identifiability"><i class="fa fa-check"></i><b>1.6.1</b> Identifiability</a></li>
<li class="chapter" data-level="1.6.2" data-path="intro.html"><a href="intro.html#estimator"><i class="fa fa-check"></i><b>1.6.2</b> Estimator</a></li>
<li class="chapter" data-level="1.6.3" data-path="intro.html"><a href="intro.html#inference"><i class="fa fa-check"></i><b>1.6.3</b> Inference</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#the-wash-benefits-example-dataset"><i class="fa fa-check"></i><b>1.7</b> The WASH Benefits Example Dataset</a><ul>
<li class="chapter" data-level="1.7.1" data-path="intro.html"><a href="intro.html#the-variables"><i class="fa fa-check"></i><b>1.7.1</b> The variables</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html"><i class="fa fa-check"></i><b>2</b> Modern Super (Machine) Learning with <code>sl3</code></a><ul>
<li class="chapter" data-level="2.1" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#learning-objectives-1"><i class="fa fa-check"></i><b>2.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#introduction"><i class="fa fa-check"></i><b>2.2</b> Introduction</a></li>
<li class="chapter" data-level="2.3" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#basic-implementation"><i class="fa fa-check"></i><b>2.3</b> Basic Implementation</a><ul>
<li class="chapter" data-level="2.3.1" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#wash-benefits-study-example"><i class="fa fa-check"></i><b>2.3.1</b> WASH Benefits Study Example</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#extensions"><i class="fa fa-check"></i><b>2.4</b> Extensions</a><ul>
<li class="chapter" data-level="2.4.1" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#customize-learner-hyperparameters"><i class="fa fa-check"></i><b>2.4.1</b> Customize Learner Hyperparameters</a></li>
<li class="chapter" data-level="2.4.2" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#screening-covariates"><i class="fa fa-check"></i><b>2.4.2</b> Screening covariates</a></li>
<li class="chapter" data-level="2.4.3" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#cross-validated-super-learner"><i class="fa fa-check"></i><b>2.4.3</b> Cross-validated super learner</a></li>
<li class="chapter" data-level="2.4.4" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#variable-importance"><i class="fa fa-check"></i><b>2.4.4</b> Variable importance</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#exercise"><i class="fa fa-check"></i><b>2.5</b> Exercise</a><ul>
<li class="chapter" data-level="2.5.1" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#predicting-myocardial-infarction-with-sl3"><i class="fa fa-check"></i><b>2.5.1</b> Predicting myocardial infarction with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="modern-super-machine-learning-with-sl3.html"><a href="modern-super-machine-learning-with-sl3.html#concluding-remarks"><i class="fa fa-check"></i><b>2.6</b> Concluding Remarks</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html"><i class="fa fa-check"></i><b>3</b> <code>tmle3</code> – The Targeted Learning Framework</a><ul>
<li class="chapter" data-level="3.1" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#learning-objectives-2"><i class="fa fa-check"></i><b>3.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#example-tmle3-for-ate"><i class="fa fa-check"></i><b>3.2</b> Example: <code>tmle3</code> for ATE</a><ul>
<li class="chapter" data-level="3.2.1" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#load-the-data"><i class="fa fa-check"></i><b>3.2.1</b> Load the Data</a></li>
<li class="chapter" data-level="3.2.2" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#define-the-variable-roles"><i class="fa fa-check"></i><b>3.2.2</b> Define the variable roles</a></li>
<li class="chapter" data-level="3.2.3" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#handle-missingness"><i class="fa fa-check"></i><b>3.2.3</b> Handle Missingness</a></li>
<li class="chapter" data-level="3.2.4" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#create-a-spec-object"><i class="fa fa-check"></i><b>3.2.4</b> Create a “Spec” Object</a></li>
<li class="chapter" data-level="3.2.5" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#define-the-learners"><i class="fa fa-check"></i><b>3.2.5</b> Define the learners</a></li>
<li class="chapter" data-level="3.2.6" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#fit-the-tmle"><i class="fa fa-check"></i><b>3.2.6</b> Fit the TMLE</a></li>
<li class="chapter" data-level="3.2.7" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#evaluate-the-estimates"><i class="fa fa-check"></i><b>3.2.7</b> Evaluate the Estimates</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#tmle3-components"><i class="fa fa-check"></i><b>3.3</b> <code>tmle3</code> Components</a><ul>
<li class="chapter" data-level="3.3.1" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#tmle3_task"><i class="fa fa-check"></i><b>3.3.1</b> <code>tmle3_task</code></a></li>
<li class="chapter" data-level="3.3.2" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#initial-likelihood"><i class="fa fa-check"></i><b>3.3.2</b> Initial Likelihood</a></li>
<li class="chapter" data-level="3.3.3" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#targeted-likelihood-updater"><i class="fa fa-check"></i><b>3.3.3</b> Targeted Likelihood (updater)</a></li>
<li class="chapter" data-level="3.3.4" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#parameter-mapping"><i class="fa fa-check"></i><b>3.3.4</b> Parameter Mapping</a></li>
<li class="chapter" data-level="3.3.5" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#putting-it-all-together"><i class="fa fa-check"></i><b>3.3.5</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#fitting-tmle3-with-multiple-parameters"><i class="fa fa-check"></i><b>3.4</b> Fitting <code>tmle3</code> with multiple parameters</a><ul>
<li class="chapter" data-level="3.4.1" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#delta-method"><i class="fa fa-check"></i><b>3.4.1</b> Delta Method</a></li>
<li class="chapter" data-level="3.4.2" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#fit"><i class="fa fa-check"></i><b>3.4.2</b> Fit</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#exercise-1"><i class="fa fa-check"></i><b>3.5</b> Exercise</a></li>
<li class="chapter" data-level="3.6" data-path="tmle3-the-targeted-learning-framework.html"><a href="tmle3-the-targeted-learning-framework.html#summary"><i class="fa fa-check"></i><b>3.6</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html"><i class="fa fa-check"></i><b>4</b> Optimal Individualized Treatment Regimes</a><ul>
<li class="chapter" data-level="4.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#learning-objectives-3"><i class="fa fa-check"></i><b>4.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#introduction-to-optimal-individualized-interventions"><i class="fa fa-check"></i><b>4.2</b> Introduction to Optimal Individualized Interventions</a></li>
<li class="chapter" data-level="4.3" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#data-structure-and-notation"><i class="fa fa-check"></i><b>4.3</b> Data Structure and Notation</a></li>
<li class="chapter" data-level="4.4" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#defining-the-causal-effect-of-an-optimal-individualized-intervention"><i class="fa fa-check"></i><b>4.4</b> Defining the Causal Effect of an Optimal Individualized Intervention</a></li>
<li class="chapter" data-level="4.5" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#binary-treatment"><i class="fa fa-check"></i><b>4.5</b> Binary treatment</a></li>
<li class="chapter" data-level="4.6" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#extensions-to-causal-effect-of-an-optimal-individualized-intervention"><i class="fa fa-check"></i><b>4.6</b> Extensions to Causal Effect of an Optimal Individualized Intervention</a><ul>
<li class="chapter" data-level="4.6.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#simpler-rules"><i class="fa fa-check"></i><b>4.6.1</b> Simpler Rules</a></li>
<li class="chapter" data-level="4.6.2" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#realistic-optimal-individual-regimes"><i class="fa fa-check"></i><b>4.6.2</b> Realistic Optimal Individual Regimes</a></li>
<li class="chapter" data-level="4.6.3" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#variable-importance-analysis"><i class="fa fa-check"></i><b>4.6.3</b> Variable Importance Analysis</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#categorical-treatment"><i class="fa fa-check"></i><b>4.7</b> Categorical treatment</a></li>
<li class="chapter" data-level="4.8" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#exercise-optimal-individualized-intervention-with-categorical-treatment"><i class="fa fa-check"></i><b>4.8</b> Exercise: Optimal Individualized Intervention with Categorical Treatment</a></li>
<li class="chapter" data-level="4.9" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#exercise-wash-benefits-data"><i class="fa fa-check"></i><b>4.9</b> Exercise: WASH Benefits Data</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html"><i class="fa fa-check"></i><b>5</b> Stochastic Treatment Regimes</a><ul>
<li class="chapter" data-level="5.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#learning-objectives-4"><i class="fa fa-check"></i><b>5.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#introduction-1"><i class="fa fa-check"></i><b>5.2</b> Introduction</a></li>
<li class="chapter" data-level="5.3" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#stochastic-interventions"><i class="fa fa-check"></i><b>5.3</b> Stochastic Interventions</a><ul>
<li class="chapter" data-level="5.3.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#identifying-the-causal-effect-of-a-stochastic-intervention"><i class="fa fa-check"></i><b>5.3.1</b> Identifying the Causal Effect of a Stochastic Intervention</a></li>
<li class="chapter" data-level="5.3.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#interpreting-the-causal-effect-of-a-stochastic-intervention"><i class="fa fa-check"></i><b>5.3.2</b> Interpreting the Causal Effect of a Stochastic Intervention</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#estimating-the-causal-effect-of-a-stochastic-intervention-with-tmle3shift"><i class="fa fa-check"></i><b>5.4</b> Estimating the Causal Effect of a Stochastic Intervention with <code>tmle3shift</code></a><ul>
<li class="chapter" data-level="5.4.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#simulate-data-1"><i class="fa fa-check"></i><b>5.4.1</b> Simulate Data</a></li>
<li class="chapter" data-level="5.4.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#targeted-estimation-of-stochastic-interventions-effects"><i class="fa fa-check"></i><b>5.4.2</b> Targeted Estimation of Stochastic Interventions Effects</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#stochastic-interventions-over-a-grid-of-counterfactual-shifts"><i class="fa fa-check"></i><b>5.5</b> Stochastic Interventions over a Grid of Counterfactual Shifts</a><ul>
<li class="chapter" data-level="5.5.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#initializing-vimshift-through-its-tmle3_spec"><i class="fa fa-check"></i><b>5.5.1</b> Initializing <code>vimshift</code> through its <code>tmle3_Spec</code></a></li>
<li class="chapter" data-level="5.5.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#targeted-estimation-of-stochastic-intervention-effects"><i class="fa fa-check"></i><b>5.5.2</b> Targeted Estimation of Stochastic Intervention Effects</a></li>
<li class="chapter" data-level="5.5.3" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#inference-with-marginal-structural-models"><i class="fa fa-check"></i><b>5.5.3</b> Inference with Marginal Structural Models</a></li>
<li class="chapter" data-level="5.5.4" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#directly-targeting-the-msm-parameter-beta"><i class="fa fa-check"></i><b>5.5.4</b> Directly Targeting the MSM Parameter <span class="math inline">\(\beta\)</span></a></li>
<li class="chapter" data-level="5.5.5" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#example-with-the-wash-benefits-data"><i class="fa fa-check"></i><b>5.5.5</b> Example with the WASH Benefits Data</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#exercises"><i class="fa fa-check"></i><b>5.6</b> Exercises</a><ul>
<li class="chapter" data-level="5.6.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#review-of-key-concepts"><i class="fa fa-check"></i><b>5.6.1</b> Review of Key Concepts</a></li>
<li class="chapter" data-level="5.6.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#the-ideas-in-action"><i class="fa fa-check"></i><b>5.6.2</b> The Ideas in Action</a></li>
<li class="chapter" data-level="5.6.3" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#advanced-topics"><i class="fa fa-check"></i><b>5.6.3</b> Advanced Topics</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The <code>tlverse</code> Software Ecosystem for Causal Inference</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tmle3-the-targeted-learning-framework" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> <code>tmle3</code> – The Targeted Learning Framework</h1>
<p><em>Jeremy Coyle</em>, based on the <a href="https://github.com/tlverse/tmle3"><code>tmle3</code> package</a></p>
<p>Updated: 2019-05-06</p>
<div id="learning-objectives-2" class="section level2">
<h2><span class="header-section-number">3.1</span> Learning Objectives</h2>
<!--- appears as "X.1: Learning Objectives" in the book, where X is the chapter
corresponding to stochastic interventions -->
<ol style="list-style-type: decimal">
<li>Use <code>tmle3</code> to estimate an Average Treatment Effect (ATE)</li>
<li>Understand <code>tmle3</code> “Specs”</li>
<li>Fit <code>tmle3</code> for a custom set of parameters</li>
<li>Use the delta method to estimate transformations of parameters</li>
</ol>
</div>
<div id="example-tmle3-for-ate" class="section level2">
<h2><span class="header-section-number">3.2</span> Example: <code>tmle3</code> for ATE</h2>
<p>We’ll illustrate the most basic use of TMLE using the WASH Benefits data introduced earlier and estimating an Average Treatment Effect (ATE)</p>
<!-- This will be covered in detail in Alan's roadmap chapter, but we should remind people -->
<p>As a reminder, the ATE is identified with the following statistical parameter (under assumptions):
<span class="math inline">\(ATE = E_0(Y(1)=Y(0)) = E_0\left( E_0[Y \mid A=1,W]-E_0[Y \mid A=0,W] \right),\)</span></p>
<div id="load-the-data" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Load the Data</h3>
<p>We’ll use the same WASH Benefits data as the earlier chapters:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(here)
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(tmle3)
<span class="kw">library</span>(sl3)
washb_data &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;washb_data.csv&quot;</span>), <span class="dt">stringsAsFactors =</span> <span class="ot">TRUE</span>)</code></pre>
</div>
<div id="define-the-variable-roles" class="section level3">
<h3><span class="header-section-number">3.2.2</span> Define the variable roles</h3>
<p>We’ll use the common W (covariates), A (treatment/intervention), Y (outcome) data structure. <code>tmle3</code> needs to know what variables in the dataset correspond to each of these roles. We use a list of character vectors to tell it. We call this a “Node List” as it corresponds to the nodes in a Directed Acyclic Graph (DAG), a way of displaying causal relationships between variables.</p>
<pre class="sourceCode r"><code class="sourceCode r">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">W =</span> <span class="kw">c</span>(
    <span class="st">&quot;month&quot;</span>, <span class="st">&quot;aged&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;momage&quot;</span>, <span class="st">&quot;momedu&quot;</span>,
    <span class="st">&quot;momheight&quot;</span>, <span class="st">&quot;hfiacat&quot;</span>, <span class="st">&quot;Nlt18&quot;</span>, <span class="st">&quot;Ncomp&quot;</span>, <span class="st">&quot;watmin&quot;</span>,
    <span class="st">&quot;elec&quot;</span>, <span class="st">&quot;floor&quot;</span>, <span class="st">&quot;walls&quot;</span>, <span class="st">&quot;roof&quot;</span>, <span class="st">&quot;asset_wardrobe&quot;</span>,
    <span class="st">&quot;asset_table&quot;</span>, <span class="st">&quot;asset_chair&quot;</span>, <span class="st">&quot;asset_khat&quot;</span>,
    <span class="st">&quot;asset_chouki&quot;</span>, <span class="st">&quot;asset_tv&quot;</span>, <span class="st">&quot;asset_refrig&quot;</span>,
    <span class="st">&quot;asset_bike&quot;</span>, <span class="st">&quot;asset_moto&quot;</span>, <span class="st">&quot;asset_sewmach&quot;</span>,
    <span class="st">&quot;asset_mobile&quot;</span>
  ),
  <span class="dt">A =</span> <span class="st">&quot;tr&quot;</span>,
  <span class="dt">Y =</span> <span class="st">&quot;whz&quot;</span>
)</code></pre>
</div>
<div id="handle-missingness" class="section level3">
<h3><span class="header-section-number">3.2.3</span> Handle Missingness</h3>
<p>Currently, missingness in <code>tmle3</code> is handled in a fairly simple way:</p>
<ul>
<li>Missing covariates are median (for continuous) or mode (for discrete)
imputed, and additional covariates indicating imputation are generated</li>
<li>Observations missing either treatment or outcome variables are excluded.</li>
</ul>
<p>We plan to implement IPCW-TMLE to more efficiently handle missingness in the
treatment and outcome variables.</p>
<p>These steps are implemented in the <code>process_missing</code> function in <code>tmle3</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">processed &lt;-<span class="st"> </span><span class="kw">process_missing</span>(washb_data, node_list)
washb_data &lt;-<span class="st"> </span>processed<span class="op">$</span>data
node_list &lt;-<span class="st"> </span>processed<span class="op">$</span>node_list</code></pre>
</div>
<div id="create-a-spec-object" class="section level3">
<h3><span class="header-section-number">3.2.4</span> Create a “Spec” Object</h3>
<p><code>tmle3</code> is general, and allows most components of the TMLE procedure to be
specified in a modular way. However, most end-users will not be interested in
manually specifying all of these components. Therefore, <code>tmle3</code> implements a
<code>tmle3_Spec</code> object that bundles a set ofcomponents into a <em>specification</em>
that, with minimal additional detail, can be run by an end-user.</p>
<p>We’ll start with using one of the specs, and then work our way down into the
internals of <code>tmle3</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">ate_spec &lt;-<span class="st"> </span><span class="kw">tmle_ATE</span>(
  <span class="dt">treatment_level =</span> <span class="st">&quot;Nutrition + WSH&quot;</span>,
  <span class="dt">control_level =</span> <span class="st">&quot;Control&quot;</span>
)</code></pre>
</div>
<div id="define-the-learners" class="section level3">
<h3><span class="header-section-number">3.2.5</span> Define the learners</h3>
<p>Currently, the only other thing a user must define are the <code>sl3</code> learners used
to estimate the relevant factors of the likelihood: Q and g.</p>
<p>This takes the form of a list of <code>sl3</code> learners, one for each likelihood factor
to be estimated with <code>sl3</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># choose base learners</span>
lrnr_mean &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_mean)
lrnr_xgboost &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_xgboost)

<span class="co"># define metalearners appropriate to data types</span>
ls_metalearner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_nnls)
mn_metalearner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_solnp, metalearner_linear_multinomial, loss_loglik_multinomial)
sl_Y &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> <span class="kw">list</span>(lrnr_mean, lrnr_xgboost), <span class="dt">metalearner =</span> ls_metalearner)
sl_A &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> <span class="kw">list</span>(lrnr_mean, lrnr_xgboost), <span class="dt">metalearner =</span> mn_metalearner)

learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">A =</span> sl_A, <span class="dt">Y =</span> sl_Y)</code></pre>
<p>Here, we use a SuperLearner as defined in the previous chapter. In the future, we plan to include reasonable defaults learners.</p>
</div>
<div id="fit-the-tmle" class="section level3">
<h3><span class="header-section-number">3.2.6</span> Fit the TMLE</h3>
<p>We now have everything we need to fit the tmle using <code>tmle3</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">tmle_fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(ate_spec, washb_data, node_list, learner_list)</code></pre>
</div>
<div id="evaluate-the-estimates" class="section level3">
<h3><span class="header-section-number">3.2.7</span> Evaluate the Estimates</h3>
<p>We can see the summary results by printing the fit object. Alternatively, we
can extra results from the summary by indexing into it:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(tmle_fit)</code></pre>
<pre><code>A tmle3_Fit that took 1 step(s)
   type                                    param    init_est    tmle_est
1:  ATE ATE[Y_{A=Nutrition + WSH}-Y_{A=Control}] 0.002374285 0.004919129
           se       lower     upper psi_transformed lower_transformed
1: 0.05093973 -0.09492091 0.1047592     0.004919129       -0.09492091
   upper_transformed
1:         0.1047592</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">estimates &lt;-<span class="st"> </span>tmle_fit<span class="op">$</span>summary<span class="op">$</span>psi_transformed
<span class="kw">print</span>(estimates)</code></pre>
<pre><code>[1] 0.004919129</code></pre>
</div>
</div>
<div id="tmle3-components" class="section level2">
<h2><span class="header-section-number">3.3</span> <code>tmle3</code> Components</h2>
<p>Now that we’ve successfully used a spec to obtain a TML estimate, let’s look
under the hood at the components. The spec has a number of functions that
generate the objects necessary to define and fit a TMLE.</p>
<div id="tmle3_task" class="section level3">
<h3><span class="header-section-number">3.3.1</span> <code>tmle3_task</code></h3>
<p>First is, a <code>tmle3_Task</code>, analogous to an <code>sl3_Task</code>, containing the data we’re
fitting the TMLE to, as well as an NP-SEM generated from the <code>node_list</code> defined
above, describing the variables and their relationships.</p>
<pre class="sourceCode r"><code class="sourceCode r">tmle_task &lt;-<span class="st"> </span>ate_spec<span class="op">$</span><span class="kw">make_tmle_task</span>(washb_data, node_list)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">tmle_task<span class="op">$</span>npsem</code></pre>
<pre><code>$W
tmle3_Node: W
    Variables: month, aged, sex, momedu, hfiacat, Nlt18, Ncomp, watmin, elec, floor, walls, roof, asset_wardrobe, asset_table, asset_chair, asset_khat, asset_chouki, asset_tv, asset_refrig, asset_bike, asset_moto, asset_sewmach, asset_mobile, momage, momheight, delta_momage, delta_momheight
    Parents: 

$A
tmle3_Node: A
    Variables: tr
    Parents: W

$Y
tmle3_Node: Y
    Variables: whz
    Parents: A, W</code></pre>
</div>
<div id="initial-likelihood" class="section level3">
<h3><span class="header-section-number">3.3.2</span> Initial Likelihood</h3>
<p>Next, is an object representing the likelihood, factorized according to the
NPSEM described above:</p>
<pre class="sourceCode r"><code class="sourceCode r">initial_likelihood &lt;-<span class="st"> </span>ate_spec<span class="op">$</span><span class="kw">make_initial_likelihood</span>(
  tmle_task,
  learner_list
)
<span class="kw">print</span>(initial_likelihood)</code></pre>
<pre><code>W: Lf_emp
A: LF_fit
Y: LF_fit</code></pre>
<p>These components of the likelihood indicate how the factors were estimated: the
marginal distribution of <span class="math inline">\(W\)</span> was estimated using NP-MLE, and the conditional
distributions of <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span> were estimated using <code>sl3</code> fits (as defined with
the <code>learner_list</code>) above.</p>
<p>We can use this in tandem with the <code>tmle_task</code> object to obtain likelihood
estimates for each observation:</p>
<pre class="sourceCode r"><code class="sourceCode r">initial_likelihood<span class="op">$</span><span class="kw">get_likelihoods</span>(tmle_task)</code></pre>
<pre><code>                 W         A          Y
   1: 0.0002129925 0.2478116 -0.6636675
   2: 0.0002129925 0.2546811 -0.6366056
   3: 0.0002129925 0.2591630 -0.6243758
   4: 0.0002129925 0.2802803 -0.6040870
   5: 0.0002129925 0.2536342 -0.5474464
  ---                                  
4691: 0.0002129925 0.1349251 -0.4674441
4692: 0.0002129925 0.1261758 -0.4862865
4693: 0.0002129925 0.1264204 -0.5709195
4694: 0.0002129925 0.1753331 -0.8200469
4695: 0.0002129925 0.1299314 -0.5445321</code></pre>
<!-- TODO: make helper to get learners out of fit objects -->
</div>
<div id="targeted-likelihood-updater" class="section level3">
<h3><span class="header-section-number">3.3.3</span> Targeted Likelihood (updater)</h3>
<p>We also need to define a “Targeted Likelihood” object. This is a special type
of likelihood that is able to be updated using an <code>tmle3_Update</code> object. This
object defines the update strategy (e.g. submodel, loss function, CV-TMLE or
not, etc).</p>
<pre class="sourceCode r"><code class="sourceCode r">targeted_likelihood &lt;-<span class="st"> </span>Targeted_Likelihood<span class="op">$</span><span class="kw">new</span>(initial_likelihood)</code></pre>
<p>When constructing the targeted likelihood, you can specify different update
options. See the documentation for <code>tmle3_Update</code> for details of the different
options. For example, you can disable CV-TMLE (the default in <code>tmle3</code>) as follows:</p>
<pre class="sourceCode r"><code class="sourceCode r">targeted_likelihood_no_cv &lt;-
<span class="st">  </span>Targeted_Likelihood<span class="op">$</span><span class="kw">new</span>(initial_likelihood,
    <span class="dt">updater =</span> <span class="kw">list</span>(<span class="dt">cvtmle =</span> <span class="ot">FALSE</span>)
  )</code></pre>
</div>
<div id="parameter-mapping" class="section level3">
<h3><span class="header-section-number">3.3.4</span> Parameter Mapping</h3>
<p>Finally, we need to define the parameters of interest. Here, the spec defines a
single parameter, the ATE. In the next section, we’ll see how to add additional
parameters.</p>
<pre class="sourceCode r"><code class="sourceCode r">tmle_params &lt;-<span class="st"> </span>ate_spec<span class="op">$</span><span class="kw">make_params</span>(tmle_task, targeted_likelihood)
<span class="kw">print</span>(tmle_params)</code></pre>
<pre><code>[[1]]
Param_ATE: ATE[Y_{A=Nutrition + WSH}-Y_{A=Control}]</code></pre>
</div>
<div id="putting-it-all-together" class="section level3">
<h3><span class="header-section-number">3.3.5</span> Putting it all together</h3>
<p>Having used the spec to manually generate all these components, we can now
manually fit a <code>tmle3</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">tmle_fit_manual &lt;-<span class="st"> </span><span class="kw">fit_tmle3</span>(
  tmle_task, targeted_likelihood, tmle_params,
  targeted_likelihood<span class="op">$</span>updater
)
<span class="kw">print</span>(tmle_fit_manual)</code></pre>
<pre><code>A tmle3_Fit that took 1 step(s)
   type                                    param    init_est    tmle_est
1:  ATE ATE[Y_{A=Nutrition + WSH}-Y_{A=Control}] 0.002420953 0.005688114
           se       lower     upper psi_transformed lower_transformed
1: 0.05066608 -0.09361558 0.1049918     0.005688114       -0.09361558
   upper_transformed
1:         0.1049918</code></pre>
<p>The result is equivalent to fitting using the <code>tmle3</code> function as above.</p>
</div>
</div>
<div id="fitting-tmle3-with-multiple-parameters" class="section level2">
<h2><span class="header-section-number">3.4</span> Fitting <code>tmle3</code> with multiple parameters</h2>
<p>Above, we fit a <code>tmle3</code> with just one parameter. <code>tmle3</code> also supports fitting
multiple parameters simultaneously. To illustrate this, we’ll use the
<code>tmle_TSM_all</code> spec:</p>
<pre class="sourceCode r"><code class="sourceCode r">tsm_spec &lt;-<span class="st"> </span><span class="kw">tmle_TSM_all</span>()
targeted_likelihood &lt;-<span class="st"> </span>Targeted_Likelihood<span class="op">$</span><span class="kw">new</span>(initial_likelihood)
all_tsm_params &lt;-<span class="st"> </span>tsm_spec<span class="op">$</span><span class="kw">make_params</span>(tmle_task, targeted_likelihood)
<span class="kw">print</span>(all_tsm_params)</code></pre>
<pre><code>[[1]]
Param_TSM: E[Y_{A=Control}]

[[2]]
Param_TSM: E[Y_{A=Handwashing}]

[[3]]
Param_TSM: E[Y_{A=Nutrition}]

[[4]]
Param_TSM: E[Y_{A=Nutrition + WSH}]

[[5]]
Param_TSM: E[Y_{A=Sanitation}]

[[6]]
Param_TSM: E[Y_{A=WSH}]

[[7]]
Param_TSM: E[Y_{A=Water}]</code></pre>
<p>This spec generates a Treatment Specific Mean (TSM) for each level of the
exposure variable. Note that we must first generate a new targeted likelihood,
as the old one was targeted to the ATE. However, we can recycle the initial likelihood we fit above,
saving us a super learner step.</p>
<div id="delta-method" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Delta Method</h3>
<p>We can also define parameters based on Delta Method Transformations of other
parameters. For instance, we can estimate a ATE using the delta method and two
of the above TSM parameters:</p>
<pre class="sourceCode r"><code class="sourceCode r">ate_param &lt;-<span class="st"> </span><span class="kw">define_param</span>(
  Param_delta, targeted_likelihood,
  delta_param_ATE,
  <span class="kw">list</span>(all_tsm_params[[<span class="dv">1</span>]], all_tsm_params[[<span class="dv">4</span>]])
)
<span class="kw">print</span>(ate_param)</code></pre>
<pre><code>Param_delta: E[Y_{A=Nutrition + WSH}] - E[Y_{A=Control}]</code></pre>
<p>This can similarly be used to estimate other derived parameters like Relative
Risks, and Population Attributable Risks</p>
</div>
<div id="fit" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Fit</h3>
<p>We can now fit a TMLE simultaneously for all TSM parameters, as well as the
above defined ATE parameter</p>
<pre class="sourceCode r"><code class="sourceCode r">all_params &lt;-<span class="st"> </span><span class="kw">c</span>(all_tsm_params, ate_param)

tmle_fit_multiparam &lt;-<span class="st"> </span><span class="kw">fit_tmle3</span>(
  tmle_task, targeted_likelihood, all_params,
  targeted_likelihood<span class="op">$</span>updater
)

<span class="kw">print</span>(tmle_fit_multiparam)</code></pre>
<pre><code>A tmle3_Fit that took 1 step(s)
   type                                       param     init_est     tmle_est
1:  TSM                            E[Y_{A=Control}] -0.598097569 -0.620355839
2:  TSM                        E[Y_{A=Handwashing}] -0.610547103 -0.641610265
3:  TSM                          E[Y_{A=Nutrition}] -0.606100696 -0.622523827
4:  TSM                    E[Y_{A=Nutrition + WSH}] -0.595676615 -0.614469201
5:  TSM                         E[Y_{A=Sanitation}] -0.591533375 -0.590238665
6:  TSM                                E[Y_{A=WSH}] -0.533175373 -0.444067807
7:  TSM                              E[Y_{A=Water}] -0.579947617 -0.536383461
8:  ATE E[Y_{A=Nutrition + WSH}] - E[Y_{A=Control}]  0.002420953  0.005886638
           se      lower      upper psi_transformed lower_transformed
1: 0.02980701 -0.6787765 -0.5619352    -0.620355839        -0.6787765
2: 0.04204793 -0.7240227 -0.5591978    -0.641610265        -0.7240227
3: 0.04253932 -0.7058994 -0.5391483    -0.622523827        -0.7058994
4: 0.04110326 -0.6950301 -0.5339083    -0.614469201        -0.6950301
5: 0.04209751 -0.6727483 -0.5077291    -0.590238665        -0.6727483
6: 0.04483865 -0.5319499 -0.3561857    -0.444067807        -0.5319499
7: 0.03928547 -0.6133816 -0.4593853    -0.536383461        -0.6133816
8: 0.05066116 -0.0934074  0.1051807     0.005886638        -0.0934074
   upper_transformed
1:        -0.5619352
2:        -0.5591978
3:        -0.5391483
4:        -0.5339083
5:        -0.5077291
6:        -0.3561857
7:        -0.4593853
8:         0.1051807</code></pre>
</div>
</div>
<div id="exercise-1" class="section level2">
<h2><span class="header-section-number">3.5</span> Exercise</h2>
<p>We’ll use data from the Collaborative Perinatal Project (CPP), available in the
<code>sl3</code> package. To simplify this example, we define a binary intervention
variable, <code>parity01</code> – an indicator of having one or more children before the
current child and a binary outcome, <code>haz01</code> – an indicator of having an above
average height for age.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load the data set</span>
<span class="kw">data</span>(cpp)
cpp &lt;-<span class="st"> </span>cpp[<span class="op">!</span><span class="kw">is.na</span>(cpp[, <span class="st">&quot;haz&quot;</span>]), ]
cpp<span class="op">$</span>parity01 &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(cpp<span class="op">$</span>parity <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)
cpp[<span class="kw">is.na</span>(cpp)] &lt;-<span class="st"> </span><span class="dv">0</span>
cpp<span class="op">$</span>haz01 &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(cpp<span class="op">$</span>haz <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</code></pre>
<p>We’re interested in using this simplified data to estimate an Average Treatment
Effect (ATE):</p>
<p><span class="math display">\[\Psi(P_0) = E_0(E_0[Y|A=1,W]-E_0[Y|A=0,W])\]</span></p>
<!-- The purely statistical (noncausal) parameter can be interpreted as the average
of the difference in means across the strata for $W$, and only requires the
positivity assumption, that the conditional treatment assignment probabilities
are positive for each possible $w:P_0(A=1|W =w)>0$ and $P_0(A=0|W =w)>0$ for
each possible $w$.

To interpret this parameter as causal, specifically the causal risk difference
$E_0Y_1-E_0Y_0$, then we would also need to make the randomization assumption
stating that $A$ is independent of the counterfactuals $(Y_0,Y_1)$ within strata
of $W$. This assumption might have been included in the original SCM
$\mathcal{M}^F$, but, if one knows there are unmeasured confounders, then the
model $\mathcal{M}^{F\*}$ would be more restrictive by enforcing this ``known to
be wrong'' randomization assumption. Still, this assumption does not change the
statistical model $\mathcal{M}$, and as a consequence, it does not affect the
estimation problem either. Thus, the theorem's that establish desirable
properties of the TMLE, still hold even when this non-testable randomization
assumption is violated.

We proceed with implementing a targeted minimum loss-based estimator (TMLE),
an efficient substitution estimator which is not only asymptotically consistent,
asymptotically normally distributed, and asymptotically efficient, but also
tailored to have robust finite sample performance. -->
<ol style="list-style-type: decimal">
<li>Define the variable roles <span class="math inline">\((W,A,Y)\)</span> by creating a list of these nodes.
Include the following baseline covariates in <span class="math inline">\(W\)</span>: <code>apgar1</code>, <code>apgar5</code>,
<code>gagebrth</code>, <code>mage</code>, <code>meducyrs</code>, <code>sexn</code>. Both <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span> are specified above.</li>
<li>Implement a <code>tmle3_Spec</code> object that bundles a set of components into a
<em>specification</em>. We are interested in specifying the ATE, for which we use
<code>tmle_ATE()</code>.</li>
<li>Define <code>sl3</code> base learners to estimate <span class="math inline">\(Q = E(Y|A,Y)\)</span> and <span class="math inline">\(g=P(A|W)\)</span>.</li>
<li>Define metalearners appropriate for data types.</li>
<li>Define a Super Learner for estimating <span class="math inline">\(Q\)</span> and another for estimating <span class="math inline">\(g\)</span>.</li>
<li>Create a list of the two Super Learners defined in Step 5 and call this
object. The list names should be <code>A</code> (defining the Super Learner for
estimating <span class="math inline">\(g\)</span>) and <code>Y</code> (defining the Super Learner for estimating <span class="math inline">\(Q\)</span>).</li>
<li>Fit the tmle with the <code>tmle3</code> function. At a minimum, this function will
requires specification of (1) the <code>tmle3_Spec</code>, which we defined in Step 2; (2)
the data; (3) the list of nodes, which defined the varible roles in Step 1; and</li>
</ol>
<ol start="4" style="list-style-type: decimal">
<li>the list of Super Learners for estimating <span class="math inline">\(g\)</span> and <span class="math inline">\(Q\)</span>, which we defined in
Step 6. Note: Like before, you will need to make a data copy to deal with
<code>data.table</code> weirdness (<code>cpp2 &lt;- data.table::copy(cpp)</code>) and use <code>cpp2</code> to fit
the tmle.</li>
</ol>
<ol start="8" style="list-style-type: decimal">
<li>Interpret the <code>tmle3</code> fit both causally and statistically.</li>
</ol>
</div>
<div id="summary" class="section level2">
<h2><span class="header-section-number">3.6</span> Summary</h2>
<p><code>tmle3</code> is a general purpose framework for generating TML estimates. The
easiest way to use it is to use a predefined spec, allowing you to just fill in
the blanks for the data, variable roles, and <code>sl3</code> learners. However, digging
under the hood allows users to specify a wide range of TMLEs. In the next
sections, we’ll see how this framework can be used to estimate advanced
parameters such as optimal treatments and shift interventions.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="modern-super-machine-learning-with-sl3.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="optimal-individualized-treatment-regimes.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/tlverse/acic2019-workshop/edit/master/04-tmle3.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["acic2019_workshop.pdf", "acic2019_workshop.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
